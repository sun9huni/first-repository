# -*- coding: utf-8 -*-
"""D.I.V.E. AI ì •ì°© ì‹œë®¬ë ˆì´í„° (ë°°í¬ìš© ìµœì¢…ë²„ì „)

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1V0rU8HPGvA34wH7y062ZHRhlBT1_RJPR
"""

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import requests
import json

# ---------------------------------
# ë°ì´í„° ë¡œë“œ (ê°€ìƒ ë°ì´í„°)
# ---------------------------------
@st.cache_data
def load_data():
    """ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì‚¬ìš©ë  ëª¨ë“  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  DataFrameìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤."""
    region_data = [
        { 'id': 'A', 'name': 'ê°•ì›ë„ ê°•ë¦‰ì‹œ', 'budget': 280, 'job_tags': ['local', 'digital'], 'community': 4, 'scores': { 'ë¹„ìš©': 3, 'ì¼ìë¦¬': 4, 'ì»¤ë®¤ë‹ˆí‹°': 4, 'ì ‘ê·¼ì„±': 3, 'ë¬¸í™”/ì—¬ê°€': 4 } },
        { 'id': 'B', 'name': 'ì „ë¼ë¶ë„ ì „ì£¼ì‹œ', 'budget': 220, 'job_tags': ['local', 'public'], 'community': 5, 'scores': { 'ë¹„ìš©': 4, 'ì¼ìë¦¬': 3, 'ì»¤ë®¤ë‹ˆí‹°': 5, 'ì ‘ê·¼ì„±': 4, 'ë¬¸í™”/ì—¬ê°€': 5 } },
        { 'id': 'C', 'name': 'ì œì£¼íŠ¹ë³„ìì¹˜ë„ ì œì£¼ì‹œ', 'budget': 350, 'job_tags': ['digital', 'local'], 'community': 4, 'scores': { 'ë¹„ìš©': 2, 'ì¼ìë¦¬': 5, 'ì»¤ë®¤ë‹ˆí‹°': 4, 'ì ‘ê·¼ì„±': 3, 'ë¬¸í™”/ì—¬ê°€': 5 } },
        { 'id': 'D', 'name': 'ê²½ìƒë¶ë„ ì•ˆë™ì‹œ', 'budget': 180, 'job_tags': ['local', 'public'], 'community': 3, 'scores': { 'ë¹„ìš©': 5, 'ì¼ìë¦¬': 2, 'ì»¤ë®¤ë‹ˆí‹°': 3, 'ì ‘ê·¼ì„±': 2, 'ë¬¸í™”/ì—¬ê°€': 4 } },
        { 'id': 'E', 'name': 'ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ', 'budget': 200, 'job_tags': ['local', 'public'], 'community': 4, 'scores': { 'ë¹„ìš©': 4, 'ì¼ìë¦¬': 3, 'ì»¤ë®¤ë‹ˆí‹°': 4, 'ì ‘ê·¼ì„±': 3, 'ë¬¸í™”/ì—¬ê°€': 4 } },
    ]

    job_data = [
        { 'id': 1, 'name': 'ê°•ë¦‰ì‹œ ê´€ê´‘ ìŠ¤íƒ€íŠ¸ì—… ë§ˆì¼€í„°', 'type': 'local', 'region_id': 'A', 'base_score': 92 },
        { 'id': 2, 'name': 'ì „ì£¼ì‹œ í•œì˜¥ë§ˆì„ ì½˜í…ì¸  ê¸°íšì', 'type': 'local', 'region_id': 'B', 'base_score': 95 },
        { 'id': 3, 'name': 'ì œì£¼ì‹œ ITê¸°ì—… ì›ê²©ê·¼ë¬´ ê°œë°œì', 'type': 'digital', 'region_id': 'C', 'base_score': 98 },
        { 'id': 4, 'name': 'ì•ˆë™ì‹œ ìœ êµë¬¸í™” ë””ì§€í„¸ ì•„ì¹´ì´ë¸Œ êµ¬ì¶•', 'type': 'public', 'region_id': 'D', 'base_score': 88 },
        { 'id': 5, 'name': 'ìˆœì²œë§Œêµ­ê°€ì •ì› ìŠ¤ë§ˆíŠ¸íŒœ ìš´ì˜ìš”ì›', 'type': 'local', 'region_id': 'E', 'base_score': 91 },
        { 'id': 9, 'name': 'ì›ê²© ê·¼ë¬´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì', 'type': 'digital', 'region_id': None, 'base_score': 95 },
    ]

    benefits_data = [
        { 'id': 1, 'region_id': 'A', 'category': 'ì²­ë…„', 'name': 'ê°•ë¦‰ì‹œ ì²­ë…„ ì›”ì„¸ ì§€ì›' },
        { 'id': 2, 'region_id': 'A', 'category': 'ì°½ì—…', 'name': 'ë¡œì»¬í¬ë¦¬ì—ì´í„° ìœ¡ì„± ì§€ì›' },
        { 'id': 3, 'region_id': 'B', 'category': 'ì²­ë…„', 'name': 'ì „ì£¼ì²­ë…„ ìƒìƒ(ç›¸ç”Ÿ)ì¹´ë“œ' },
        { 'id': 4, 'region_id': 'C', 'category': 'ì£¼ê±°', 'name': 'ì œì£¼í˜• ì²­ë…„ ì£¼ê±°ë³´ì¥ ì •ì±…' },
        { 'id': 8, 'region_id': 'E', 'category': 'ì²­ë…„', 'name': 'ìˆœì²œì‹œ ì²­ë…„ ì í”„ì—… í”„ë¡œì íŠ¸' },
        { 'id': 7, 'region_id': 'D', 'category': 'ì£¼ê±°', 'name': 'ê·€ë†ì¸ ì •ì°©ì¥ë ¤ê¸ˆ ì§€ì›' },
    ]
    return pd.DataFrame(region_data), pd.DataFrame(job_data), pd.DataFrame(benefits_data)

region_df, job_df, benefits_df = load_data()

# ---------------------------------
# Streamlit ì•± UI êµ¬ì„±
# ---------------------------------

st.set_page_config(layout="centered", page_title="D.I.V.E - AI ì •ì°© ë‚˜ì¹¨ë°˜")

# --- CSS ìŠ¤íƒ€ì¼ ---
st.markdown("""
<style>
    .stApp {
        background-color: #f0f4f8;
    }
    .main-title {
        text-align: center;
        font-size: 2.5rem;
        font-weight: 800;
        color: #1f2937;
    }
    .sub-title {
        text-align: center;
        font-size: 1.125rem;
        color: #6b7280;
        margin-top: 0.5rem;
        margin-bottom: 3rem;
    }
    .step-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        height: 100%;
        background-color: #ffffff;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .step-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #374151;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .result-grid-item {
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        padding: 1rem;
        background-color: #f9fafb;
    }
</style>
""", unsafe_allow_html=True)


# --- íƒ€ì´í‹€ ---
st.markdown('<p class="main-title">D.I.V.E í”Œë«í¼ í•µì‹¬ ê¸°ëŠ¥</p>', unsafe_allow_html=True)
st.markdown('<p class="sub-title">AI ê¸°ë°˜ ì •ì°© ì‹œë®¬ë ˆì´í„°ì˜ ì‚¬ìš©ì ì—¬ì • ë° í•µì‹¬ ê¸°ëŠ¥</p>', unsafe_allow_html=True)


# --- STEP 1 & 2 ---
col1, col2 = st.columns(2)

with col1:
    with st.container(border=True):
        st.markdown('<h2 class="step-title" style="font-size: 1.125rem; font-weight: 700; color: #374151;">STEP 1. ì¡°ê±´ ì…ë ¥</h2>', unsafe_allow_html=True)
        st.caption("ì •ì°© í¬ë§ ì¡°ê±´ ì„¤ì •")

        budget = st.slider("ì›” ê°€ìš© ì˜ˆì‚° (ë§Œì›)", 100, 500, 260, 10, help="ìƒí™œë¹„, ì£¼ê±°ë¹„ ë“±ì„ í¬í•¨í•œ í•œ ë‹¬ ì˜ˆì‚°ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.")
        job_type_display = st.selectbox("í¬ë§ ì§ë¬´ ìœ í˜•", ('ë””ì§€í„¸/ì›ê²©', 'ì§€ì—­ ê¸°ë°˜(ë†ì—…/ê´€ê´‘)', 'ê³µê³µ/ì‚¬íšŒì„œë¹„ìŠ¤'))
        community_labels = ['ë§¤ìš° ë‚®ìŒ', 'ë‚®ìŒ', 'ì¤‘ê°„', 'ë†’ìŒ', 'ë§¤ìš° ë†’ìŒ']
        community_display = st.select_slider("ì»¤ë®¤ë‹ˆí‹° ì„ í˜¸ë„", options=community_labels, value='ì¤‘ê°„')

        # API í‚¤ ì…ë ¥ í•„ë“œëŠ” ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ë‚¨ê²¨ë‘ê³ , ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” Secretsë¥¼ ìš°ì„  ì‚¬ìš©í•©ë‹ˆë‹¤.
        api_key_input = st.text_input("Google Gemini API í‚¤ (ì„ íƒ ì‚¬í•­)", type="password", help="í´ë¼ìš°ë“œ ë°°í¬ ì‹œì—ëŠ” ì´ ì¹¸ì„ ë¹„ì›Œë‘ê³  Secretsì— í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.")

with col2:
    with st.container(border=True):
        st.markdown('<h2 class="step-title" style="font-size: 1.125rem; font-weight: 700; color: #374151;">STEP 2. AI ë¶„ì„</h2>', unsafe_allow_html=True)
        st.caption("ë°ì´í„° ê¸°ë°˜ ìµœì ì§€ íƒìƒ‰")
        st.markdown("""
        - ğŸ  **ì£¼ê±°/ìƒí™œë¹„ ë¶„ì„:** êµ­í† ë¶€ ì‹¤ê±°ë˜ê°€ ë° ì§€ì—­ ë¬¼ê°€ ë°ì´í„° ê¸°ë°˜
        - ğŸ’¼ **ì¼ìë¦¬ ì ‘ê·¼ì„± ë¶„ì„:** ê³ ìš©ë…¸ë™ë¶€ ë° ë¯¼ê°„ ì±„ìš© ë°ì´í„° ê¸°ë°˜
        - ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **ì»¤ë®¤ë‹ˆí‹° í™œì„±ë„ ë¶„ì„:** ì§€ì—­ ì»¤ë®¤ë‹ˆí‹° ë° ë¬¸í™” ì‹œì„¤ ë°ì´í„° ê¸°ë°˜
        - âœ”ï¸ **ìµœì¢… ì •ì°©ì ìˆ˜ ë° ì í•©ë„ ê³„ì‚°**
        """)

st.markdown("<div style='text-align: center; font-size: 2rem; color: #9ca3af; margin: 2rem 0;'>â†“</div>", unsafe_allow_html=True)


# ---------------------------------
# í•µì‹¬ ë¡œì§
# ---------------------------------
job_type_map = {'ë””ì§€í„¸/ì›ê²©': 'digital', 'ì§€ì—­ ê¸°ë°˜(ë†ì—…/ê´€ê´‘)': 'local', 'ê³µê³µ/ì‚¬íšŒì„œë¹„ìŠ¤': 'public'}
job_type_val = job_type_map[job_type_display]
community_val = community_labels.index(community_display) + 1

filtered_regions = region_df[(region_df['budget'] <= budget) & (region_df['job_tags'].apply(lambda x: job_type_val in x))].copy()
if filtered_regions.empty:
    filtered_regions = region_df[region_df['budget'] <= budget].copy()
if filtered_regions.empty:
    filtered_regions = region_df.copy()

scores = [ (5 - abs(row['community'] - community_val)) * 0.4 + row['scores']['ì¼ìë¦¬'] * 0.6 for _, row in filtered_regions.iterrows() ]
filtered_regions['final_score'] = scores
best_region = filtered_regions.loc[filtered_regions['final_score'].idxmax()]

# --- STEP 3 ---
with st.container(border=True):
    st.markdown('<h2 class="step-title" style="font-size: 1.125rem; font-weight: 700; color: #374151;">STEP 3. í†µí•© ê²°ê³¼ ë¦¬í¬íŠ¸</h2>', unsafe_allow_html=True)
    st.caption("AI ì‹œë®¬ë ˆì´í„°ë¥¼ í†µí•´ ì œê³µë˜ëŠ” 4ê°€ì§€ í•µì‹¬ ì •ë³´")

    grid_col1, grid_col2 = st.columns(2)

    with grid_col1:
        with st.container(border=True):
            st.markdown("**A. ì§€ì—­ ì¶”ì²œ & ì •ì°© ì ìˆ˜**")
            st.caption(f"ì¶”ì²œ ì§€ì—­: **:blue[{best_region['name']}]**")

            sub_col1, sub_col2 = st.columns(2)
            with sub_col1:
                st.markdown("<p style='font-size: 0.75rem; text-align: center; font-weight: 600;'>ì¢…í•© ì •ì°© ì ìˆ˜</p>", unsafe_allow_html=True)
                radar_fig = go.Figure(data=go.Scatterpolar(
                    r=list(best_region['scores'].values()),
                    theta=list(best_region['scores'].keys()),
                    fill='toself'
                ))
                radar_fig.update_layout(height=200, margin=dict(l=40, r=40, t=40, b=40))
                st.plotly_chart(radar_fig, use_container_width=True)

            with sub_col2:
                st.markdown("<p style='font-size: 0.75rem; text-align: center; font-weight: 600;'>ì˜ˆìƒ ì›”ë³„ ìˆ˜ì…/ì§€ì¶œ</p>", unsafe_allow_html=True)
                income = (best_region['scores']['ì¼ìë¦¬'] / 5) * 400 + 150
                finance_data = {'ê¸ˆì•¡': [income, best_region['budget']]}
                finance_df = pd.DataFrame(finance_data, index=["ìˆ˜ì…", "ì§€ì¶œ"])
                st.bar_chart(finance_df, height=180)

        with st.container(border=True):
            st.markdown("**C. ë§ì¶¤ í˜œíƒ ì •ë³´**")
            matched_benefits = benefits_df[benefits_df['region_id'] == best_region['id']]
            if not matched_benefits.empty:
                tags = ""
                for _, row in matched_benefits.iterrows():
                    tags += f"<span style='background-color: #e0e7ff; color: #3730a3; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem;'>{row['category']}</span>"
                st.markdown(tags, unsafe_allow_html=True)
            else:
                st.info("ê´€ë ¨ í˜œíƒ ì •ë³´ ì—†ìŒ")


    with grid_col2:
        with st.container(border=True):
            st.markdown("**B. ì¶”ì²œ ì¼ìë¦¬ ë§¤ì¹­**")
            jobs_to_match = job_df.copy()
            is_digital_remote = (jobs_to_match['type'] == 'digital') & jobs_to_match['region_id'].isnull()
            is_local_match = jobs_to_match['region_id'] == best_region['id']
            matched_jobs = jobs_to_match[(jobs_to_match['type'] == job_type_val) & (is_digital_remote | is_local_match)]

            if not matched_jobs.empty:
                suitability_scores = [min(99, job['base_score'] + (5 if community_val >= 4 and best_region['community'] >= 4 else 0) + (3 if budget > best_region['budget'] + 50 else 0)) for _, job in matched_jobs.iterrows()]
                matched_jobs['suitability'] = suitability_scores
                top_jobs = matched_jobs.sort_values(by='suitability', ascending=False).head(2)

                for _, job in top_jobs.iterrows():
                    st.markdown(f"<p style='font-size: 0.875rem; font-weight: 600;'>{job['name']}</p>", unsafe_allow_html=True)
                    st.progress(job['suitability'], text=f"{job['suitability']}%")
            else:
                st.info("ì¶”ì²œ ì¼ìë¦¬ ì—†ìŒ")

        with st.container(border=True):
            st.markdown("**D. AI ìƒì„± ì¸ì‚¬ì´íŠ¸**")

            # st.secretsë¥¼ ìš°ì„ ì ìœ¼ë¡œ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            api_key = st.secrets.get("GEMINI_API_KEY", api_key_input)

            if not api_key:
                st.warning("AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, ë°°í¬ í™˜ê²½ì˜ Secretsì— í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
            else:
                if st.button("AI ì •ì°© ì»¨ì„¤íŒ… ë° ê³„íš ë°›ê¸°", use_container_width=True):
                    with st.spinner("AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                        prompt = f"""
                        ë‹¹ì‹ ì€ ì¹œì ˆí•œ ì •ì°© ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
                        í•œ ì‚¬ìš©ìê°€ '{best_region['name']}'ìœ¼ë¡œì˜ ì´ì£¼ë¥¼ ê³ ë ¤í•˜ê³  ìˆìœ¼ë©°, í”„ë¡œí•„ì€ ì›” ì˜ˆì‚° {budget}ë§Œì›, í¬ë§ ì§ë¬´ '{job_type_display}', ì»¤ë®¤ë‹ˆí‹° ì„ í˜¸ë„ '{community_display}'ì…ë‹ˆë‹¤.
                        1. **ì •ì°© ì»¨ì„¤íŒ…**: ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, í•´ë‹¹ ì§€ì—­ì—ì„œì˜ ì‚¶ì´ ì–´ë–¨ì§€ì— ëŒ€í•´ í˜„ì‹¤ì ì¸ ì¡°ì–¸ì„ 2~3ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                        2. **ì‹¤í–‰ ê³„íš ì´ˆì•ˆ**: ì´ì£¼ë¥¼ ìœ„í•œ 3ë‹¨ê³„ ì‹¤í–‰ ê³„íšì„ ê°„ë‹¨íˆ ì œì•ˆí•´ì£¼ì„¸ìš”.
                        """
                        payload = {"contents": [{"role": "user", "parts": [{"text": prompt}]}]}
                        api_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={api_key}"

                        try:
                            response = requests.post(api_url, json=payload, headers={'Content-Type': 'application/json'})
                            response.raise_for_status()
                            result = response.json()
                            if 'candidates' in result:
                                st.success(result['candidates'][0]['content']['parts'][0]['text'])
                            else:
                                st.error("AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                        except Exception as e:
                            st.error(f"AI í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")